{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kaelo/store-link/components/marketplace/FullMarketplaceClient.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useEffect, useCallback, useMemo } from \"react\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport Image from \"next/image\";\r\nimport Link from \"next/link\"; \r\nimport { \r\n  Search, Package, Filter, Loader2, CheckCircle, \r\n  Plus, ShoppingBag, BadgeCheck, Gem, Zap, TrendingUp \r\n} from \"lucide-react\"; \r\nimport { useCart } from \"@/context/CartContext\"; \r\n\r\ninterface FullMarketplaceClientProps {\r\n  initialProducts: any[];\r\n  categories: { id: string; name: string; slug: string }[]; \r\n}\r\n\r\nexport default function FullMarketplaceClient({ initialProducts, categories }: FullMarketplaceClientProps) {\r\n  const { addToCart, cartCount, setIsCartOpen } = useCart();\r\n  const PAGE_SIZE = 12;\r\n\r\n  // --- 1. CORE STATES ---\r\n  const [products, setProducts] = useState(initialProducts);\r\n  const [loading, setLoading] = useState(false);\r\n  const [hasMore, setHasMore] = useState(true);\r\n  const [page, setPage] = useState(Math.ceil(initialProducts.length / PAGE_SIZE));\r\n  const [search, setSearch] = useState(\"\");\r\n  const [debouncedSearch, setDebouncedSearch] = useState(\"\"); // âœ¨ Fix: For Global Database Search\r\n  const [selectedCategory, setSelectedCategory] = useState(\"all\"); \r\n  const [toast, setToast] = useState<{ show: boolean; msg: string }>({ show: false, msg: \"\" });\r\n  const [flashOnly, setFlashOnly] = useState(false); \r\n  const [isJumping, setIsJumping] = useState(false);\r\n\r\n  // --- NEW: SCROLL DIRECTION LOGIC (FIXED) ---\r\n  const [isVisible, setIsVisible] = useState(true);\r\n  const [lastScrollY, setLastScrollY] = useState(0);\r\n\r\n  useEffect(() => {\r\n    const handleScroll = () => {\r\n      const currentScrollY = window.scrollY;\r\n      // Hide bar if scrolling down > 100px, show if scrolling up\r\n      if (currentScrollY > lastScrollY && currentScrollY > 100) {\r\n        setIsVisible(false);\r\n      } else {\r\n        setIsVisible(true);\r\n      }\r\n      setLastScrollY(currentScrollY);\r\n    };\r\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\r\n    return () => window.removeEventListener(\"scroll\", handleScroll);\r\n  }, [lastScrollY]);\r\n\r\n  // --- âœ¨ SEARCH DEBOUNCE LOGIC ---\r\n  useEffect(() => {\r\n    const handler = setTimeout(() => {\r\n      setDebouncedSearch(search);\r\n    }, 500); // Wait 500ms before querying Supabase\r\n    return () => clearTimeout(handler);\r\n  }, [search]);\r\n\r\n  // --- 2. LOGIC AUDIT: REWARDS & PROTECTION ---\r\n  const trendingDrops = useMemo(() => {\r\n    const now = new Date();\r\n    return products.filter(p => \r\n      p.flash_drop_expiry && new Date(p.flash_drop_expiry) > now\r\n    ).slice(0, 8);\r\n  }, [products]);\r\n\r\n  const applyDowngradeProtection = useCallback((items: any[]) => {\r\n    const counts = new Map();\r\n    const now = new Date();\r\n    return items.filter(p => {\r\n      const plan = p.stores?.subscription_plan;\r\n      const expiry = p.stores?.subscription_expiry;\r\n      if (expiry && new Date(expiry) < now) return false;\r\n      if (plan === 'premium' || plan === 'diamond') return true;\r\n      const count = counts.get(p.store_id) || 0;\r\n      if (count < 5) {\r\n        counts.set(p.store_id, count + 1);\r\n        return true;\r\n      }\r\n      return false;\r\n    });\r\n  }, []);\r\n\r\n  const handleAddToCart = (product: any) => {\r\n    const isFlashActive = product.flash_drop_expiry && new Date(product.flash_drop_expiry) > new Date();\r\n    if (isFlashActive) {\r\n      const audio = new Audio('/sounds/empire-drop.mp3');\r\n      audio.volume = 0.5;\r\n      audio.play().catch(() => null);\r\n    }\r\n    setIsJumping(true);\r\n    setTimeout(() => setIsJumping(false), 600);\r\n    const storeData = {\r\n        id: product.store_id,\r\n        name: product.stores?.name,\r\n        slug: product.stores?.slug,\r\n        whatsapp_number: product.stores?.whatsapp_number || \"\", \r\n    };\r\n    addToCart(product, storeData as any);\r\n    setToast({ show: true, msg: `Secured ${product.name}!` });\r\n    setTimeout(() => setToast({ show: false, msg: \"\" }), 3000);\r\n  };\r\n\r\n  const getRank = (plan?: string) => {\r\n     if (plan === 'diamond') return 3;\r\n     if (plan === 'premium') return 2;\r\n     return 1;\r\n  };\r\n\r\n  // --- 3. DATA FETCHING (AUDITED FOR SERVER-SIDE SEARCH) ---\r\n  useEffect(() => {\r\n    const fetchFiltered = async () => {\r\n      // If we are resetting to initial view with no filters, just use initialProducts\r\n      if (selectedCategory === \"all\" && !debouncedSearch && !flashOnly) {\r\n        setProducts(initialProducts);\r\n        setHasMore(true);\r\n        setPage(Math.ceil(initialProducts.length / PAGE_SIZE));\r\n        return;\r\n      }\r\n\r\n      setLoading(true);\r\n      setPage(1);\r\n\r\n      let query = supabase\r\n        .from(\"storefront_products\")\r\n        .select(\"*, stores!inner(name, slug, subscription_plan, category, verification_status, subscription_expiry, loyalty_enabled, loyalty_percentage)\") \r\n        .order(\"created_at\", { ascending: false })\r\n        .range(0, 40); \r\n\r\n      if (selectedCategory !== \"all\") {\r\n        query = query.eq(\"stores.category\", selectedCategory);\r\n      }\r\n\r\n      // âœ¨ FIX: Real database search across all products\r\n      if (debouncedSearch) {\r\n        query = query.ilike(\"name\", `%${debouncedSearch}%`);\r\n      }\r\n\r\n      // âœ¨ FIX: Real database filter for flash drops\r\n      if (flashOnly) {\r\n        query = query.gt(\"flash_drop_expiry\", new Date().toISOString());\r\n      }\r\n\r\n      const { data } = await query;\r\n      let processed = applyDowngradeProtection(data || []);\r\n      \r\n      // Sort by rank if searching\r\n      if (debouncedSearch) {\r\n        processed = processed.sort((a, b) => getRank(b.stores?.subscription_plan) - getRank(a.stores?.subscription_plan));\r\n      }\r\n\r\n      setProducts(processed);\r\n      setHasMore(data && data.length >= 40 ? true : false);\r\n      setLoading(false);\r\n    };\r\n\r\n    fetchFiltered();\r\n  }, [selectedCategory, debouncedSearch, flashOnly, initialProducts, applyDowngradeProtection]);\r\n\r\n  const loadMore = async () => {\r\n    if (loading || !hasMore) return;\r\n    setLoading(true);\r\n    const from = page * 40;\r\n    const to = from + 39; \r\n\r\n    let query = supabase\r\n      .from(\"storefront_products\")\r\n      .select(\"*, stores!inner(name, slug, subscription_plan, category, verification_status, subscription_expiry, loyalty_enabled, loyalty_percentage)\")\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(from, to);\r\n\r\n    if (selectedCategory !== \"all\") query = query.eq(\"stores.category\", selectedCategory);\r\n    if (debouncedSearch) query = query.ilike(\"name\", `%${debouncedSearch}%`);\r\n    if (flashOnly) query = query.gt(\"flash_drop_expiry\", new Date().toISOString());\r\n\r\n    const { data: newProducts } = await query;\r\n    if (newProducts && newProducts.length > 0) {\r\n      const protectedNewData = applyDowngradeProtection(newProducts);\r\n      setProducts(prev => [...prev, ...protectedNewData]);\r\n      setPage(prev => prev + 1);\r\n      setHasMore(newProducts.length >= 40);\r\n    } else {\r\n      setHasMore(false);\r\n    }\r\n    setLoading(false);\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto px-4 py-6 md:py-8\">\r\n      \r\n      {/* TRENDING SECTION: PRESERVED DESIGN */}\r\n      {trendingDrops.length > 0 && !search && !flashOnly && (\r\n        <div className=\"mb-10 animate-in fade-in slide-in-from-top-4 duration-1000\">\r\n           <div className=\"flex items-center gap-2 mb-4 px-1\">\r\n              <TrendingUp size={18} className=\"text-amber-500\" />\r\n              <h2 className=\"font-black text-gray-900 uppercase tracking-tighter text-sm\">Trending Live Drops</h2>\r\n           </div>\r\n           <div className=\"flex gap-4 overflow-x-auto no-scrollbar pb-4 -mx-1 px-1\">\r\n              {trendingDrops.map(product => {\r\n                const coins = product.stores?.loyalty_enabled \r\n                  ? Math.floor(product.price * (product.stores.loyalty_percentage / 100)) \r\n                  : 0;\r\n\r\n                return (\r\n                  <Link key={`trending-${product.id}`} href={`/product/${product.id}`} className=\"min-w-[150px] md:min-w-[190px] bg-white p-2 rounded-2xl border-2 border-amber-100 shadow-sm active:scale-95 transition relative\">\r\n                     <div className=\"aspect-square relative rounded-xl overflow-hidden mb-2\">\r\n                        <Image src={product.image_urls?.[0]} alt=\"\" fill className=\"object-cover\" />\r\n                        <div className=\"absolute top-1.5 left-1.5 bg-amber-500 text-white text-[7px] font-black px-1.5 py-0.5 rounded animate-pulse\">TRENDING</div>\r\n                        \r\n                        {coins > 0 && (\r\n                          <div className=\"absolute top-1.5 right-1.5 bg-emerald-500 text-white text-[7px] font-black px-1.5 py-0.5 rounded flex items-center gap-0.5 shadow-sm\">\r\n                             <Zap size={8} fill=\"white\" /> +â‚¦{coins}\r\n                          </div>\r\n                        )}\r\n                     </div>\r\n                     <p className=\"font-bold text-gray-900 text-[10px] truncate uppercase\">{product.name}</p>\r\n                     <p className=\"text-emerald-600 font-black text-xs mt-1\">â‚¦{product.flash_drop_price?.toLocaleString()}</p>\r\n                  </Link>\r\n                );\r\n              })}\r\n           </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* FILTER BAR: DYNAMIC VISIBILITY ON SCROLL (THE FIX) */}\r\n      <div className={`sticky top-16 z-30 bg-gray-50/95 backdrop-blur-sm py-4 -mx-4 px-4 border-b border-gray-200 mb-6 transition-all duration-300 ease-in-out ${\r\n          isVisible \r\n          ? \"translate-y-0 opacity-100\" \r\n          : \"-translate-y-24 opacity-0 pointer-events-none md:translate-y-0 md:opacity-100 md:pointer-events-auto\"\r\n      }`}>\r\n        <div className=\"max-w-5xl mx-auto space-y-4\">\r\n          <div className=\"flex flex-col md:flex-row gap-3\">\r\n            <div className=\"relative flex-1\">\r\n              <Search className=\"absolute left-4 top-3.5 text-gray-400 w-5 h-5\" />\r\n              <input \r\n                placeholder=\"Search products...\" \r\n                className=\"w-full pl-12 pr-4 py-3 rounded-xl border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white text-base font-medium\"\r\n                value={search}\r\n                onChange={e => setSearch(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"relative min-w-[200px]\">\r\n               <Filter className=\"absolute left-4 top-3.5 text-gray-500 w-4 h-4\" />\r\n               <select \r\n                 className=\"w-full pl-10 pr-8 py-3 rounded-xl border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white text-gray-700 appearance-none font-bold cursor-pointer\"\r\n                 value={selectedCategory}\r\n                 onChange={(e) => setSelectedCategory(e.target.value)}\r\n               >\r\n                 <option value=\"all\">Global Feed</option>\r\n                 {(categories || []).map(cat => <option key={cat.id} value={cat.slug}>{cat.name}</option>)}\r\n               </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex gap-2\">\r\n             <button \r\n                onClick={() => setFlashOnly(!flashOnly)}\r\n                className={`px-5 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 border ${\r\n                  flashOnly \r\n                  ? \"bg-amber-500 text-white border-amber-600 shadow-lg shadow-amber-200 scale-105\" \r\n                  : \"bg-white text-amber-600 border-amber-100 hover:bg-amber-50\"\r\n                }`}\r\n             >\r\n                <Zap size={14} fill={flashOnly ? \"white\" : \"currentColor\"} className={flashOnly ? \"animate-pulse\" : \"\"} />\r\n                {flashOnly ? \"Viewing Active Drops\" : \"Show Only Live Drops\"}\r\n             </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* GLOBAL GRID: THE CORE DATA MAPPING */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-6\">\r\n        {products.map((product: any) => {\r\n          const isFlash = product.flash_drop_expiry && new Date(product.flash_drop_expiry) > new Date();\r\n          const isDiamond = product.stores?.subscription_plan === 'diamond';\r\n          const rewardCoins = product.stores?.loyalty_enabled \r\n            ? Math.floor((isFlash ? product.flash_drop_price : product.price) * (product.stores.loyalty_percentage / 100)) \r\n            : 0;\r\n          \r\n          return (\r\n            <Link \r\n              href={`/product/${product.id}`} \r\n              key={product.id} \r\n              className={`bg-white p-2.5 rounded-2xl border transition-all duration-500 flex flex-col relative h-full group ${\r\n                isDiamond \r\n                ? 'border-purple-200 shadow-[0_10px_30px_rgba(147,51,234,0.08)] ring-1 ring-purple-50' \r\n                : 'border-gray-100 shadow-sm'\r\n              } hover:shadow-2xl hover:-translate-y-2`}\r\n            >\r\n              <div className=\"aspect-square bg-gray-50 rounded-xl mb-3 relative overflow-hidden\">\r\n                <Image src={product.image_urls?.[0] || \"\"} alt=\"\" fill className=\"object-cover group-hover:scale-110 transition-transform duration-700\" />\r\n                \r\n                {isFlash ? (\r\n                  <div className=\"absolute top-2 left-2 bg-amber-500 text-white text-[9px] px-2 py-1 rounded-lg font-black shadow-lg flex items-center gap-1 z-20\">\r\n                     <Zap size={10} fill=\"currentColor\" /> LIVE DROP\r\n                  </div>\r\n                ) : isDiamond && (\r\n                  <span className=\"absolute top-2 left-2 bg-purple-600 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow-md flex items-center gap-1 z-20\">\r\n                     <Gem size={10} className=\"fill-white\"/> TOP\r\n                  </span>\r\n                )}\r\n\r\n                {rewardCoins > 0 && (\r\n                  <div className=\"absolute top-2 right-2 bg-emerald-600/90 backdrop-blur-sm text-white text-[9px] px-2 py-1 rounded-lg font-black shadow-lg flex items-center gap-1 z-20 animate-in zoom-in\">\r\n                    <Zap size={10} fill=\"white\" /> +â‚¦{rewardCoins.toLocaleString()}\r\n                  </div>\r\n                )}\r\n\r\n                <button \r\n                  onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleAddToCart(product); }}\r\n                  className={`absolute bottom-2 right-2 p-2 rounded-full shadow-lg hover:scale-125 transition-all z-10 ${isFlash ? 'bg-amber-500 text-white' : 'bg-gray-900 text-white'}`}\r\n                >\r\n                  <Plus size={18} strokeWidth={3} />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"px-1 flex flex-col flex-1\">\r\n                <h3 className=\"font-bold text-gray-900 text-xs md:text-sm truncate uppercase tracking-tight mb-0.5\">{product.name}</h3>\r\n                <div className=\"flex items-center gap-1 text-[10px] text-gray-400 mb-3 truncate font-bold\">\r\n                  <span className=\"truncate\">{product.stores?.name}</span>\r\n                  {product.stores?.verification_status === 'verified' && <BadgeCheck size={12} className=\"text-blue-500 fill-blue-50\" />}\r\n                </div>\r\n                <div className=\"mt-auto flex items-center justify-between\">\r\n                  {isFlash ? (\r\n                    <div>\r\n                      <p className=\"text-[9px] font-bold text-gray-300 line-through\">â‚¦{product.price.toLocaleString()}</p>\r\n                      <p className=\"text-emerald-700 font-black text-sm md:text-base tracking-tighter\">â‚¦{product.flash_drop_price.toLocaleString()}</p>\r\n                    </div>\r\n                  ) : (\r\n                    <p className=\"text-emerald-700 font-black text-sm md:text-base\">â‚¦{product.price.toLocaleString()}</p>\r\n                  )}\r\n                  {product.stock_quantity === 0 && (\r\n                     <span className=\"text-[8px] bg-red-50 text-red-600 px-2 py-1 rounded font-black uppercase tracking-widest\">Sold Out</span>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              {isDiamond && <div className=\"absolute inset-0 pointer-events-none rounded-2xl border-2 border-transparent group-hover:border-purple-500/10 transition-colors\" />}\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {/* FOOTER ACTIONS: PAGINATION */}\r\n      {hasMore && products.length >= 12 && (\r\n        <div className=\"mt-12 flex justify-center\">\r\n          <button \r\n            onClick={loadMore} \r\n            disabled={loading}\r\n            className=\"px-10 py-4 bg-white border-2 border-gray-900 text-gray-900 rounded-2xl font-black uppercase text-xs tracking-[0.2em] hover:bg-gray-900 hover:text-white transition-all disabled:opacity-50 flex items-center gap-3 active:scale-95 shadow-xl\"\r\n          >\r\n            {loading ? <Loader2 className=\"animate-spin\" size={18} /> : \"Load More Products\"}\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {toast.show && (\r\n        <div className=\"fixed top-24 right-4 z-[60] bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in slide-in-from-right-10\">\r\n           <CheckCircle size={20} className=\"text-emerald-400\" />\r\n           <span className=\"font-bold text-sm\">{toast.msg}</span>\r\n        </div>\r\n      )}\r\n\r\n      {cartCount > 0 && ( \r\n        <button \r\n          onClick={() => setIsCartOpen(true)} \r\n          className={`fixed bottom-8 right-8 bg-gray-900 text-white p-5 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.3)] z-50 transition-all active:scale-90 ${isJumping ? 'animate-bounce bg-emerald-600' : 'hover:scale-110 animate-in zoom-in'}`}\r\n        >\r\n          <ShoppingBag size={24} />\r\n          <span className=\"absolute -top-1 -right-1 bg-emerald-500 w-7 h-7 rounded-full flex items-center justify-center text-xs font-black border-2 border-white\">\r\n            {cartCount} \r\n          </span>\r\n        </button>\r\n      )}\r\n\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 750, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kaelo/store-link/utils/shuffle.ts"],"sourcesContent":["export function shuffleArray<T>(array: T[]): T[] {\r\n  const shuffled = [...array]; \r\n  for (let i = shuffled.length - 1; i > 0; i--) {\r\n    const j = Math.floor(Math.random() * (i + 1));\r\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\r\n  }\r\n  return shuffled;\r\n}"],"names":[],"mappings":";;;;AAAO,SAAS,aAAgB,KAAU;IACxC,MAAM,WAAW;WAAI;KAAM;IAC3B,IAAK,IAAI,IAAI,SAAS,MAAM,GAAG,GAAG,IAAI,GAAG,IAAK;QAC5C,MAAM,IAAI,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,CAAC,IAAI,CAAC;QAC3C,CAAC,QAAQ,CAAC,EAAE,EAAE,QAAQ,CAAC,EAAE,CAAC,GAAG;YAAC,QAAQ,CAAC,EAAE;YAAE,QAAQ,CAAC,EAAE;SAAC;IACzD;IACA,OAAO;AACT"}},
    {"offset": {"line": 771, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kaelo/store-link/app/marketplace/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport Link from \"next/link\";\r\nimport { LayoutDashboard, ArrowLeft } from \"lucide-react\";\r\nimport FullMarketplaceClient from \"@/components/marketplace/FullMarketplaceClient\";\r\nimport { shuffleArray } from \"@/utils/shuffle\";\r\n\r\n// ... (Metadata stays the same)\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function MarketplacePage() {\r\n  \r\n  const { data: rawProducts } = await supabase\r\n    .from(\"storefront_products\") \r\n    .select(`\r\n      *, \r\n      stores!inner(\r\n        name, \r\n        whatsapp_number, \r\n        slug, \r\n        subscription_plan, \r\n        category, \r\n        verification_status, \r\n        subscription_expiry,\r\n        loyalty_enabled,\r\n        loyalty_percentage\r\n      )\r\n    `) \r\n    .eq(\"is_active\", true)\r\n    // ðŸ‘ˆ THE QUERY FIX: Filter out 'free' plans directly at the database level\r\n    .neq(\"stores.subscription_plan\", \"free\")\r\n    .order(\"created_at\", { ascending: false }) \r\n    .limit(100);\r\n\r\n  const storeItemTracker: Record<string, number> = {};\r\n  const now = new Date();\r\n  \r\n  // ðŸ‘ˆ THE LOGIC AUDIT: Ensuring strictly Premium/Diamond access\r\n  const filteredByPlan = (rawProducts || []).filter(product => {\r\n    const plan = product.stores?.subscription_plan;\r\n    const storeId = product.store_id;\r\n    const expiry = product.stores?.subscription_expiry;\r\n\r\n    // 1. Check Expiry first\r\n    if (expiry && new Date(expiry) < now) {\r\n      return false;\r\n    }\r\n\r\n    // 2. ONLY allow Premium or Diamond. \r\n    // Free users are blocked by the .neq in the query, but we double-check here.\r\n    if (plan !== 'diamond' && plan !== 'premium') {\r\n      return false;\r\n    }\r\n\r\n    // 3. For Diamond/Premium, we can still limit the number of items \r\n    // per store to keep the marketplace diverse (Fresh-Shuffle Logic).\r\n    const currentCount = storeItemTracker[storeId] || 0;\r\n    if (currentCount < 10) { // Diamond/Premium get more visibility\r\n      storeItemTracker[storeId] = currentCount + 1;\r\n      return true;\r\n    }\r\n    \r\n    return false;\r\n  });\r\n\r\n  const shuffledProducts = shuffleArray(filteredByPlan.slice(0, 60));\r\n\r\n  const { data: categories } = await supabase\r\n    .from(\"categories\")\r\n    .select(\"id, name, slug\")\r\n    .is(\"store_id\", null) \r\n    .order(\"name\", { ascending: true });\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 font-sans flex flex-col\">\r\n        \r\n       <nav className=\"bg-white border-b border-gray-200 sticky top-0 z-40 px-4 h-16 flex items-center justify-between shadow-sm\">\r\n         <Link href=\"/\" className=\"font-extrabold text-xl tracking-tight text-gray-900 flex items-center gap-2\">\r\n            <LayoutDashboard className=\"text-emerald-600\"/> StoreLink\r\n         </Link>\r\n         \r\n         <div className=\"hidden md:block font-bold text-gray-400 text-sm uppercase tracking-wider\">\r\n            Marketplace\r\n         </div>\r\n\r\n         <Link href=\"/\" className=\"flex items-center gap-2 font-bold text-gray-500 hover:text-gray-900 transition text-sm bg-gray-100 px-3 py-2 rounded-xl hover:bg-gray-200\">\r\n           <ArrowLeft size={16} /> <span className=\"hidden md:inline\">Back to Home</span>\r\n         </Link>\r\n       </nav>\r\n\r\n       <div className=\"flex-1\">\r\n         <FullMarketplaceClient \r\n            initialProducts={shuffledProducts || []} \r\n            categories={categories || []} \r\n         />\r\n       </div>\r\n\r\n       <footer className=\"bg-white border-t border-gray-200 py-8 mt-auto\">\r\n          <div className=\"max-w-6xl mx-auto px-4 text-center\">\r\n              <p className=\"font-extrabold text-gray-300 text-2xl mb-2 flex items-center justify-center gap-2\">\r\n                  <LayoutDashboard className=\"text-gray-200\"/> StoreLink\r\n              </p>\r\n              <p className=\"text-xs text-gray-300 mt-6\">Â© {new Date().getFullYear()} StoreLink. All rights reserved.</p>\r\n          </div>\r\n       </footer>\r\n\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":";;;;;;;AAEA;AACA;AACA;AAAA;AACA;AACA;AANA;;;;;;;AAUO,MAAM,UAAU;AAER,eAAe;IAE5B,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,2HAAQ,CACzC,IAAI,CAAC,uBACL,MAAM,CAAC,CAAC;;;;;;;;;;;;;IAaT,CAAC,EACA,EAAE,CAAC,aAAa,KACjB,2EAA2E;KAC1E,GAAG,CAAC,4BAA4B,QAChC,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM,GACvC,KAAK,CAAC;IAET,MAAM,mBAA2C,CAAC;IAClD,MAAM,MAAM,IAAI;IAEhB,+DAA+D;IAC/D,MAAM,iBAAiB,CAAC,eAAe,EAAE,EAAE,MAAM,CAAC,CAAA;QAChD,MAAM,OAAO,QAAQ,MAAM,EAAE;QAC7B,MAAM,UAAU,QAAQ,QAAQ;QAChC,MAAM,SAAS,QAAQ,MAAM,EAAE;QAE/B,wBAAwB;QACxB,IAAI,UAAU,IAAI,KAAK,UAAU,KAAK;YACpC,OAAO;QACT;QAEA,qCAAqC;QACrC,6EAA6E;QAC7E,IAAI,SAAS,aAAa,SAAS,WAAW;YAC5C,OAAO;QACT;QAEA,kEAAkE;QAClE,mEAAmE;QACnE,MAAM,eAAe,gBAAgB,CAAC,QAAQ,IAAI;QAClD,IAAI,eAAe,IAAI;YACrB,gBAAgB,CAAC,QAAQ,GAAG,eAAe;YAC3C,OAAO;QACT;QAEA,OAAO;IACT;IAEA,MAAM,mBAAmB,IAAA,gIAAY,EAAC,eAAe,KAAK,CAAC,GAAG;IAE9D,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,2HAAQ,CACxC,IAAI,CAAC,cACL,MAAM,CAAC,kBACP,EAAE,CAAC,YAAY,MACf,KAAK,CAAC,QAAQ;QAAE,WAAW;IAAK;IAEnC,qBACE,8OAAC;QAAI,WAAU;;0BAEZ,8OAAC;gBAAI,WAAU;;kCACb,8OAAC,uKAAI;wBAAC,MAAK;wBAAI,WAAU;;0CACtB,8OAAC,+OAAe;gCAAC,WAAU;;;;;;4BAAoB;;;;;;;kCAGlD,8OAAC;wBAAI,WAAU;kCAA2E;;;;;;kCAI1F,8OAAC,uKAAI;wBAAC,MAAK;wBAAI,WAAU;;0CACvB,8OAAC,6NAAS;gCAAC,MAAM;;;;;;4BAAM;0CAAC,8OAAC;gCAAK,WAAU;0CAAmB;;;;;;;;;;;;;;;;;;0BAI/D,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC,8JAAqB;oBACnB,iBAAiB,oBAAoB,EAAE;oBACvC,YAAY,cAAc,EAAE;;;;;;;;;;;0BAIjC,8OAAC;gBAAO,WAAU;0BACf,cAAA,8OAAC;oBAAI,WAAU;;sCACX,8OAAC;4BAAE,WAAU;;8CACT,8OAAC,+OAAe;oCAAC,WAAU;;;;;;gCAAiB;;;;;;;sCAEhD,8OAAC;4BAAE,WAAU;;gCAA6B;gCAAG,IAAI,OAAO,WAAW;gCAAG;;;;;;;;;;;;;;;;;;;;;;;;AAMpF"}}]
}